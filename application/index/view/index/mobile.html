<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="http://g.tbcdn.cn/mtb/lib-flexible/0.3.4/??flexible_css.js,flexible.js"></script>
    <link rel="stylesheet" href="__STATIC__/index/css/mobile.css" />
    <title>工作安排表</title>
</head>

<body>
<div class="box">
    <h1>工作安排表</h1>
    <!--选择年月-->
    <div class="date-box">
        <select name="year">
            <option value="2016">2016年</option>
            <option value="2017">2017年</option>
            <option value="2018">2018年</option>
            <option value="2019">2019年</option>
            <option value="2020">2020年</option>
            <option value="2021">2021年</option>
            <option value="2022">2022年</option>
            <option value="2023">2023年</option>
            <option value="2024">2024年</option>
            <option value="2025">2025年</option>
            <option value="2026">2026年</option>
        </select>
        <select name="month">
            <option value="1">1月</option>
            <option value="2">2月</option>
            <option value="3">3月</option>
            <option value="4">4月</option>
            <option value="5">5月</option>
            <option value="6">6月</option>
            <option value="7">7月</option>
            <option value="8">8月</option>
            <option value="9">9月</option>
            <option value="10">10月</option>
            <option value="11">11月</option>
            <option value="12">12月</option>
        </select>
        <a class="confirm" href="javascript:;">确定</a>
        <input type="hidden" name="nian" value="{:input('param.year')}">
        <input type="hidden" name="yue" value="{:input('param.month')}">
    </div>
    <!--选择年月结束-->
   <!-- 色块代表注释-->
    <div class="notice">
            <p>
                <span class="explain">一般：</span>
                <span class="color pink"></span>
            </p>
            <p>
                <span class="explain">重要：</span>
                <span class="color orange"></span>
            </p>
            <p>
                <span class="explain">紧急：</span>
                <span class="color yellow"></span>
            </p>
        <p>
            <span class="explain">提前：</span>
            <span class="color blue"></span>
        </p>
            <p>
                <span class="explain">软删除：</span>
                <span class="color gray"></span>
            </p>
            <p>
                <span class="explain">已完成：</span>
                <span class="color green"></span>
            </p>
    </div>
    <!-- 色块代表注释结束-->
    <!--表格头部-->
    <div class="header">
        <div class="name">姓名</div>
        <div class="title">计划名称</div>
        <div class="process">工作进程</div>
    </div>
    <!--表格结束-->
   <!-- 表格主体-->
    <ul class="ul">
        {foreach name='data' item='v'}
        <li class="li">
            <div class="name">
                <p class="person-name">
                    {if condition="$v['remark']"}
                    {$v['name']}({$v['remark']})
                    {else /}
                    {$v['name']}
                    {/if}
                </p>
            </div>
            <div class="title">
                <div class="title-header">
                    计划名称
                </div>
                <div class="title-box">
                    {foreach name="v['plan']" item='vo'}
                    <div class="title-every">
                        {if condition="$vo['url']"}
                        <a class="url" target="_blank" href="{$vo['url']}">{$vo['title']}</a>
                        {else /}
                        {$vo['title']}
                        {/if}
                    </div>
                    {/foreach}
                </div>
            </div>
            <div class="process">
                <div class="timetable">
                    <p class="day">1</p>
                    <p class="day">2</p>
                    <p class="day">3</p>
                    <p class="day">4</p>
                    <p class="day">5</p>
                    <p class="day">6</p>
                    <p class="day">7</p>
                    <p class="day">8</p>
                    <p class="day">9</p>
                    <p class="day">10</p>
                    <p class="day">11</p>
                    <p class="day">12</p>
                    <p class="day">13</p>
                    <p class="day">14</p>
                    <p class="day">15</p>
                    <p class="day">16</p>
                    <p class="day">17</p>
                    <p class="day">18</p>
                    <p class="day">19</p>
                    <p class="day">20</p>
                    <p class="day">21</p>
                    <p class="day">22</p>
                    <p class="day">23</p>
                    <p class="day">24</p>
                    <p class="day">25</p>
                    <p class="day">26</p>
                    <p class="day">27</p>
                    <p class="day">28</p>
                    <p class="day">29</p>
                    <p class="day">30</p>
                    <p style="border-right: none" class="day">31</p>
                </div>
                <div class="process-box">
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p class="td"></p>
                    <p style="border-right: none" class="td"></p>

                </div>
                <div class="time-outbox">
                    {foreach name="v['plan']" item='vo'}
                    {if condition="$vo['startdate']==''"}
                    <div class="time-box">
                    </div>
                    {else /}
                    <div class="time-box">
                        {if condition="($vo['sfwc']) and ($vo['well'])"}
                        <div class="time green">
                            <input type="hidden" name="id" value="{$vo['id']}">
                            <input type="hidden" name="startdate" value="{:ltrim(strrchr($vo['startdate'],'-'),'-')}">
                            <input type="hidden" name="enddate" value="{:ltrim(strrchr($vo['enddate'],'-'),'-')}">
                            <div class="time-right"></div>
                        </div>
                        {/if}
                        {if condition="(!$vo['sfwc']) and ($vo['zycd']==0) and ($vo['well']) and (!$vo['ahead'])"}
                        <div class="time pink">
                            <input type="hidden" name="id" value="{$vo['id']}">
                            <input type="hidden" name="startdate" value="{:ltrim(strrchr($vo['startdate'],'-'),'-')}">
                            <input type="hidden" name="enddate" value="{:ltrim(strrchr($vo['enddate'],'-'),'-')}">
                            <div class="time-right"></div>
                            <div class="time-left"></div>
                        </div>
                        {/if}
                        {if condition="(!$vo['sfwc']) and ($vo['zycd']==1) and ($vo['well']) and (!$vo['ahead'])"}
                        <div class="time orange">
                            <input type="hidden" name="id" value="{$vo['id']}">
                            <input type="hidden" name="startdate" value="{:ltrim(strrchr($vo['startdate'],'-'),'-')}">
                            <input type="hidden" name="enddate" value="{:ltrim(strrchr($vo['enddate'],'-'),'-')}">
                            <div class="time-right"></div>
                            <div class="time-left"></div>
                        </div>
                        {/if}
                        {if condition="(!$vo['sfwc']) and ($vo['zycd']==2) and ($vo['well']) and (!$vo['ahead'])"}
                        <div class="time yellow">
                            <input type="hidden" name="id" value="{$vo['id']}">
                            <input type="hidden" name="startdate" value="{:ltrim(strrchr($vo['startdate'],'-'),'-')}">
                            <input type="hidden" name="enddate" value="{:ltrim(strrchr($vo['enddate'],'-'),'-')}">
                            <div class="time-right"></div>
                            <div class="time-left"></div>
                        </div>
                        {/if}
                        {if condition="(!$vo['sfwc']) and ($vo['well']) and ($vo['ahead'])"}
                        <div class="time blue">
                            <input type="hidden" name="id" value="{$vo['id']}">
                            <input type="hidden" name="startdate" value="{:ltrim(strrchr($vo['startdate'],'-'),'-')}">
                            <input type="hidden" name="enddate" value="{:ltrim(strrchr($vo['enddate'],'-'),'-')}">
                            <div class="time-right"></div>
                        </div>
                        {/if}
                        {if condition="(!$vo['sfwc']) and (!$vo['well'])"}
                        <div class="time gray">
                            <input type="hidden" name="id" value="{$vo['id']}">
                            <input type="hidden" name="startdate" value="{:ltrim(strrchr($vo['startdate'],'-'),'-')}">
                            <input type="hidden" name="enddate" value="{:ltrim(strrchr($vo['enddate'],'-'),'-')}">
                            <div class="time-right"></div>
                        </div>
                        {/if}
                    </div>
                    {/if}
                    {/foreach}
                </div>

            </div>
        </li>
        {/foreach}
    </ul>
    <!-- 表格主体结束-->

</div>
<script type="text/javascript" src="__STATIC__/index/js/zepto.min.js"></script>
<script type="text/javascript" src="__STATIC__/index/js/jquery.js"></script>
<script type="text/javascript">
    $(function ()  {
        //设置ul的高度
        var length=$('li').length;
        //ul的高度由li的数量决定
        var ul_height=430*length+(length-1);
        //设置ul的高度
        $('ul').css({'height':ul_height+'px'});

        //设置色块的长度 位置
        var time_length=$('.time').length;
        var time=$('.time');
        for(var i=0;i<time_length;i++){
            var startdate=Number(time.eq(i).find('input[name=startdate]').val());
            var enddate=Number(time.eq(i).find('input[name=enddate]').val());
            var day=(enddate-startdate)+1;
            var time_width=7*day+(day-1);
            var time_left=7*(startdate-1)+(startdate-1);
            time.eq(i).css({'width':time_width+'px','left':time_left+'px'});
        }
        //设置色块的长度 位置结束

        //滑块右侧拉短拉长
        $('.time-right').bind('touchstart',function (ev) {
            if($(this).parent('.time').hasClass('gray') || $(this).parent('.time').hasClass('green')){
                return false;
            }else{
                if($(this).parent('.time').hasClass('f') || $(this).hasClass('width')){
                    return false;
                }
                $(this).addClass('width');
                var touch=ev.originalEvent.targetTouches[0];
                m_left=touch.pageX;
                old_width=$(this).parent('.time').width();
                time_l=$(this).parent('.time').position().left;
                //alert(time_left);
                $('.time-right').bind('touchmove',function (ev) {
                    var touch=ev.originalEvent.targetTouches[0];
                    m_n_left=touch.pageX;
                    diff_left=m_n_left-m_left;
                    new_width=diff_left+old_width;
                    if(new_width<7){
                        new_width=7;
                    }
                    max_width=247-time_l;
                    if(new_width>max_width){
                        new_width=max_width;
                    }
                    $(this).css({'right':'0px'});
                    $(this).parent('.time').css({'width':new_width+'px'})
                })
            }

        })
        $('.time-right').bind('touchend',function () {
            $('.time-right').off('touchmove');
            if($(this).parent('.time').hasClass('f')){
                return false;
            }
            var p_width=$(this).parent('.time').width();
            //alert(p_width);
            console.log('宽度'+p_width);
            /*if(p_width<7){
                p_width=7;
            }
            var time_left=$(this).parent('.time').position().left;
            max_timewidth=247-time_left;
            if(p_width>max_timewidth){
                p_width=max_width;
            }*/
            var day=parseInt((p_width+1)/7-1)+1;
            //alert(day);
            var startdate=Number($(this).parent('.time').find('input[name=startdate]').val());
            //alert(startdate);
            var enddate=startdate+day-1;
            if(enddate<startdate){
                enddate=startdate
            }
            if(enddate>31){
                enddate=31;
            }
            console.log('拉长结束时间'+enddate);
            new_day=enddate-startdate+1
            var time_width=7*new_day+(new_day-1);
            $('.width').parent('.time').find('input[name=enddate]').val(enddate);
            $('.width').css({'right':'0px'});
            $('.width').parent('.time').css({'width':time_width+'px'});
            var id=Number($(this).parent('.time').find('input[name=id]').val());
            //alert(time_width);
            $.ajax({
                url:"http://work.linran136.com/index/index/width",
                data:{id:id,enddate:enddate},
                type:'post',
                success:function (reg) {
                    console.log(reg);
                    if(reg){
                        $('.width').removeClass('width');
                    }
                }
            })

        })
        //滑块右侧拉短拉长结束

        //滑块左侧拉短拉长
        $('.time-left').bind('touchstart',function (ev) {
            if($(this).parent('.time').hasClass('gray') || $(this).parent('.time').hasClass('green')){
                return false;
            }else{
                if($(this).parent('.time').hasClass('f') || $(this).siblings('.time-right').hasClass('width') || $(this).hasClass('left-width')){
                    // alert(1);
                    return false;
                }
                $(this).addClass('left-width');
                var touch=ev.originalEvent.targetTouches[0];
                m_left=touch.pageX;
                console.log(m_left);
                old_width=$(this).parent('.time').width();
                time_l=$(this).parent('.time').position().left;
                console.log('旧左侧'+time_l);
                time_r=time_l+old_width;
                //alert(time_r);
                console.log('右侧'+time_r);
                console.log('旧宽度'+old_width);
                //alert(time_left);
                $('.time-left').bind('touchmove',function (ev) {
                    var touch=ev.originalEvent.targetTouches[0];
                    m_n_left=touch.pageX;
                    diff_left=m_n_left-m_left;
                    // new_width=diff_left+old_width;
                    new_left=diff_left+time_l;
                    console.log('新左侧'+new_left);
                    /*  if(new_width<20){
                          new_width=20;
                      }
                      max_width=650-time_r;
                      if(new_width>max_width){
                          new_width=max_width;
                      }*/
                    if(new_left<0){
                        new_left=0
                    }
                    var max_l=time_r-7;
                    if(new_left>max_l){
                        new_left=max_l;
                    }
                    new_width=time_r-new_left;
                    console.log('新宽度'+new_width);
                    $('.left-width').parent('.time').css({'left':new_left+'px'});
                    $('.left-width').parent('.time').css({'width':new_width+'px'});
                    $('.left-width').css({'left':'0px'});
                    $('.left-width').siblings('.time-right').css({'right':'0px'});
                    //$('.width').parent('.time').css({'right':time_r+'px'});
                })
            }

        })
        $('.time-left').bind('touchend',function () {
            $('.time-left').off('touchmove');
            var end_left=$(this).parent('.time').position().left;
            //alert(p_width);
            var  startdate=parseInt(end_left/8)+1;
            //alert(day);
            var enddate=Number($('.left-width').parent('.time').find('input[name=enddate]').val());
            //alert(startdate);
            console.log('左侧拉动时鼠标按下时的结束时间'+enddate);
            if(startdate<1){
                startdate=1;
            }
            if(startdate>enddate){
                startdate=enddate;
            }
            console.log('左侧拉动时新的开始时间'+startdate);
            time_end_left=7*(startdate-1)+(startdate-1);
            console.log('左侧拉动抬起新左侧'+time_end_left);
            time_end_width=time_r-time_end_left ;
            console.log('左侧拉动抬起新宽度'+time_end_width);
            $('.left-width').parent('.time').find('input[name=startdate]').val(startdate);
            $('.left-width').parent('.time').css({'width':time_end_width+'px'});
            $('.left-width').parent('.time').css({'left':time_end_left+'px'});
            $('.left-width').css({'left':'0px'});
            $('.left-width').siblings('.time-right').css({'right':'0px'});
            var id=Number($('.left-width').parent('.time').find('input[name=id]').val());
            //alert(time_width);
            $.ajax({
                url:"http://work.linran136.com/index/index/leftwidth",
                data:{id:id,startdate:startdate},
                type:'post',
                success:function (reg) {
                    console.log(reg);
                    if(reg){
                        $('.left-width').removeClass('left-width');
                    }
                }
            })
        })
        //滑块左侧拉短拉长结束

        //左右移动
        $('.time').bind('touchstart',function (ev) {
            if($(this).hasClass('gray') || $(this).hasClass('green')){
                return false;
            }else {
                if($(this).find('.time-right').hasClass('width') || $(this).hasClass('f')){
                    return false;
                }
                $(this).addClass('f');
                console.log('移动');
                var touch=ev.originalEvent.targetTouches[0];
                mouse_left=touch.pageX;
               // alert(mouse_left);
                o_left=$(this).position().left;
                //alert(mouse_left)
                $('.time').bind('touchmove',function (ev) {
                    var touch=ev.originalEvent.targetTouches[0];
                    var mouse_new_left=touch.pageX;
                    var differ_left=mouse_new_left-mouse_left;
                    var time_new_left=o_left+differ_left;
                    if(time_new_left<0){
                        time_new_left=0;
                    }
                    /*var start=Number($(this).find('input[name=startdate]').val());
                    var to=Number($(this).find('input[name=enddate]').val());
                    console.log('移动'+to);
                    var d=to-start+1;*/
                    t_width=$(this).width();
                    max_left=247-t_width;
                    if(time_new_left>max_left){
                        time_new_left=max_left;
                    }
                    $('.f').find('.time-right').css({'right':'0px'});
                    $('.f').css({'left':time_new_left+'px'});
                })
            }
        })
        $('.time').bind('touchend',function () {
            $('.time').off('touchmove');
            if($(this).find('.time-right').hasClass('width')){
                return false;
            }
            var time_left=$(this).position().left;
           // alert(time_left);
            console.log('位置'+time_left);
            var old_startdate=Number($('.f').find('input[name=startdate]').val());
            startdate=parseInt(time_left/8)+1;
            if(startdate<1){
                startdate=1;
            }
            var ahead=0;
            if(startdate<old_startdate){
                ahead=1;
            }else {
                ahead=0;
            }
            var old_enddate=Number($('.f').find('input[name=enddate]').val());
            var old_day=old_enddate-old_startdate+1;
            var max_startdate=31-old_day+1;
            if(startdate>max_startdate){
                startdate=max_startdate;
            }
            var enddate=startdate+old_day-1;
            console.log('移动结束时间'+enddate);
           /* if(enddate<startdate+old_day-1){
                enddate=startdate;
            }
            if(enddate>31){
                enddate=31;
            }*/
            /*max_startdate=enddate-old_day+1;
            if(startdate>max_startdate){
                startdate=max_startdate;
            }*/
            var time_n_left=7*(startdate-1)+(startdate-1);
            //alert(startdate);
            $('.f').find('input[name=startdate]').val(startdate);
            $('.f').find('input[name=enddate]').val(enddate);
            $('.f').find('.time_right').css({'right':'0px'});
            $('.f').css({'left':time_n_left+'px'});
            if(ahead==1){
                $('.f').css({'background':'blue'});
            }
            var id=Number($('.f').find('input[name=id]').val());
           // alert(id);
            $.ajax({
                url:'http://work.linran136.com/index/index/left',
                data:{id:id,startdate:startdate,enddate:enddate,ahead:ahead},
                type:'post',
                success:function (reg) {
                    console.log(reg);
                    if(reg){
                        $('.f').removeClass('f');
                    }
                }
            })
        })
        //左右移动

        //默认当前年
        var now_year=(new Date()).getFullYear();
        //alert(now_year);
        var new_year=Number($('input[name=nian]').val());
        // alert(new_month);
        if(new_year){
            $('select[name=year]').val(new_year);
        }else{
            $('select[name=year]').val(now_year);
        }
        //默认当前年结束

        //默认当前月
        var now_month=new Date().getMonth()+1;
        // alert(new_month);
        var new_month=Number($('input[name=yue]').val());
        // alert(new_month);
        if(new_month){
            $('select[name=month]').val(new_month);
        }else{
            $('select[name=month]').val(now_month);
        }
        //默认当前月结束

        //确定年月
        $('.confirm').click(function () {
            var year=Number($('select[name=year]').val());
            var month=Number($('select[name=month]').val());
            location.href='http://work.linran136.com/index/index/mobile.html?year='+year+'&month='+month;
        })
        //确定年月结束
    })
</script>
</body>
</html>